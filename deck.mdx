import { CodeSurfer } from "mdx-deck-code-surfer"
import { Image, Head } from 'mdx-deck'
import { default as base } from 'mdx-deck/themes'
import Mermaid from './components/mermaid'
import prismStyle from 'react-syntax-highlighter/styles/prism/ghcolors'
import erlang from 'react-syntax-highlighter/languages/prism/erlang'

<Head>
  <title>erlang ìŠ¤í„°ë”” 3ì°¨ ë°œí‘œ</title>

  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://lyse-3.chitacan.io"/>
  <meta property="og:image" content="https://learnyousomeerlang.com/static/img/splash-book.png"/>
  <meta property="og:image:type" content="image/png"/>
  <meta property="og:title" content="erlang"/>
  <meta property="og:description" content="erlang ìŠ¤í„°ë”” 3ë²ˆì§¸ ë°œí‘œ"/>

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:domain" content="lyse-3.chitacan.io" />
  <meta name="twitter:title" content="erlang" />
  <meta name="twitter:description" content="erlang ìŠ¤í„°ë”” 3ë²ˆì§¸ ë°œí‘œ" />
  <meta name="twitter:url" content="https://lyse-3.chitacan.io" />
  <meta name="twitter:image" content="https://learnyousomeerlang.com/static/img/splash-book.png" />
</Head>

export const theme = {
  ...base,
  css: {
    ...base.css,
    'li > ul, li > ol': {
      fontSize: '1em'
    },
    'li > p': {
      fontSize: '1em',
      margin: 0,
    },
    li: {
      margin: '8px 0'
    }
  },
  prism: {
    style: {...prismStyle},
    languages: {
      erlang
    }
  }
}

# erlang

<a href="https://chitacan.io" target="_blank">@chitacan</a>

---

* [chapter 15. Rage Against The Finite-State Machines](https://learnyousomeerlang.com/finite-state-machines)
* [chapter 16. Event Handlers](https://learnyousomeerlang.com/event-handlers)
* [chapter 17. Who Supervises The Supervisors?](https://learnyousomeerlang.com/supervisors)
* [chapter 18. Building an Application With OTP](https://learnyousomeerlang.com/building-applications-with-otp)
* [chapter 19. Building OTP Applications](https://learnyousomeerlang.com/building-otp-applications)

---

## ch 15. Rage Against The Finite-State Machines

---

# Finite-State Machines??

* í•œë²ˆì— í•˜ë‚˜ì˜ ìƒíƒœë§Œì„ ê°€ì§
* `event` ë¥¼ í†µí•´ ìƒíƒœë¥¼ ì „í™˜
* `gen_fsm` (deprecated) ë˜ëŠ” `get_statem`

---

# ì½ì€ ì†Œê°?

* ì €ìê°€ (ê°‘ìê¸°) ì„¤ëª…ì¶©ì´ ëœ ëŠë‚Œ?? (ë„ˆë¬´ ë³µì¡í•œ ì˜ˆì œ...)
* ì½ê¸° ì „ì—ëŠ” "ì˜¤ ìƒíƒœë¨¸ì‹ ì´ ìˆë‹¤ê³ ?"
* ì½ì€ í›„ì—ëŠ” "ì•„ì§ë„ ì´í•´ê°€ ì•ˆë˜ë„¤ ğŸ˜•"
* `gen_fsm`ì´ [deprecated](http://erlang.org/doc/man/gen_fsm.html) ë˜ì–´ ë™ê¸°ë¶€ì—¬ë§ˆì € ë–¨ì–´ì§
* í•˜ì§€ë§Œ, 2ê°œì˜ fsm ì´ í†µì‹ í•˜ëŠ” ë¶€ë¶„ì€ ì•„ì£¼ í¥ë¯¸ë¡œì›€

---

# `gen_statem`

* `gen_statem` provides a generic state machine behaviour and replaces its predecessor `gen_fsm` since Erlang/OTP 20.0.
* 2ê°€ì§€ `callback mode` ì§€ì›
* Event postponing, State time-out ...
* ë¯¸ë˜ê°€ ìˆì–´ë³´ì´ëŠ” `gen_statem` ìœ¼ë¡œ ì§„í–‰í•¨

---

# `pushbutton` module

* `trade_fsm` ì´ ë„ˆë¬´ ì–´ë ¤ì›Œì„œ
* `gen_statem` ì— ë‚˜ì™€ìˆëŠ” `pushbutton` ì˜ˆì œë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ...
* 2ê°€ì§€ ìƒíƒœë§Œ ìˆëŠ” ì•„ì£¼ ê°„ë‹¨í•œ state machine

<Mermaid id="pushbutton_1" content={`
  graph LR
    A((off)) -- push --> B((on))
    B -- push / Data + 1 --> A
  `} />

---

<CodeSurfer
  title="run pushbutton"
  lang="erlang"
  code={`$ erl
1> c(pushbutton).
{ok,pushbutton}
2> pushbutton:start().
{ok,<0.87.0>}
3> pushbutton:push().
on
4> pushbutton:push().
off
5> pushbutton:push().
on
6> pushbutton:push().
off
7> pushbutton:get_count().
2`}
/>

---

<CodeSurfer
  title="pushbutton.erl"
  code={require("!raw-loader!./snippets/pushbutton.erl")}
  steps={[
    {notes: ""},
    {lines: [1,2]},
    {range: [8,17], notes: () => (<p><code>call/3</code>, <code>cast/2</code>ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŒ</p>)},
    {range: [23,25]},
    {range: [28,29], notes: () => (<p><code>off</code> ìƒíƒœì—ì„œ <code>gen_statem:call(pushbutton, push)</code>ë¥¼ í˜¸ì¶œí•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>)},
    {range: [33,34], notes: () => (<p><code>on</code> ìƒíƒœì—ì„œ <code>gen_statem:call(pushbutton, push)</code>ë¥¼ í˜¸ì¶œí•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>)},
    {lines: [30,31,35,36,38,39], notes: () => (<p><code>gen_statem:call(pushbutton, get_count)</code>ë¥¼ í˜¸ì¶œí•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>)}
  ]}
/>

---

## ch 16. Event Handlers

---

# `gen_event`

<img src={require("file-loader!./images/gen_event.jpg")}/>

* ì´ë²¤íŠ¸ë¥¼ subscriber (í•¨ìˆ˜) ë¡œ í¬ì›Œë”© í•´ì£¼ëŠ” í”„ë¡œì„¸ìŠ¤
* ì´ë²¤íŠ¸ê°€ ì²˜ë¦¬ë˜ëŠ” handler í•¨ìˆ˜ë¥¼ ì—¬ëŸ¬ ëª¨ë“ˆì— ë‚˜ëˆ„ì–´ êµ¬í˜„í•˜ê³ , ë™ì ìœ¼ë¡œ ì¶”ê°€ / ì‚­ì œê°€ ê°€ëŠ¥í•¨
* `event manager` ì™€ `handler` ëŠ” ê°™ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë¨

---

<CodeSurfer
  title="run curling_scoreboard"
  lang="erlang"
  code={`$ erl
1> c(curling_scoreboard_hw), c(curling_scoreboard).
{ok,curling_scoreboard}
2> {ok, Pid} = gen_event:start_link().
{ok,<0.91.0>}
3> gen_event:add_handler(Pid, curling_scoreboard, []).
ok
4> gen_event:notify(Pid, {set_teams, "a", "b"}).
handle_event on <0.91.0>
ok
Scoreboard: Team a vs. Team b
5> gen_event:delete_handler(Pid, curling_scoreboard, off).
ok
6> gen_event:notify(Pid, {set_teams, "a", "b"}).
ok`}
  steps={[
    {},
    {lines: [4]},
    {lines: [6,8]},
    {lines: [5,9], notes: "handler ëŠ” ê°™ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë¨"},
    {lines: [12], notes: "handler ëŠ” ë™ì ìœ¼ë¡œ ì¶”ê°€ / ì‚­ì œê°€ ê°€ëŠ¥í•¨"},
    {lines: [14,15], notes: "handler ê°€ ì—†ëŠ” ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ë©´ ok ë°˜í™˜"}
  ]}
/>

---

## `gen_event:add_sup_handler/3`

* `caller` í”„ë¡œì„¸ìŠ¤ê°€ í¬ë˜ì‹œë˜ë©´, ë“±ë¡ëœ `handler` ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œì²˜ë¦¬
* `handler` ê°€ ì‚­ì œë˜ë©´, `caller` í”„ë¡œì„¸ìŠ¤ì— ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì „ë‹¬

---

# ì½ì€ ì†Œê°?

* `gen_event` ëŠ” `gen_server` ì˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ íŠ¹í™”ë²„ì „?
* `handler` ê°€ ê°™ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì²˜ë¦¬ë˜ê¸° ë•Œë¬¸ì— blocking ì— ìœ ì˜í•´ì•¼ í•¨

---

## ch 17. Who Supervises the Supervisors?

---

# `supervisor`

* `callback` ì€ `init/1` ë¿ì´ì§€ë§Œ, ê°€ì¥ ë³µì¡í•œ ì˜µì…˜ì„ ê°€ì§€ê³  ìˆëŠ” behaviour ğŸ§™â€â™‚ï¸
* erlang í”„ë¡œì„¸ìŠ¤ë¥¼ ê°ì‹œí•  ìˆ˜ ìˆìŒ
* supervision tree ë¥¼ ìˆœì„œì— ë§ê²Œ ì¢…ë£Œì‹œì¼œ ì¤Œ

<img src={require("file-loader!./images/shutdown.jpg")}/>

---

## `init/1` callback

`{ok, {{RestartStrategy, MaxRestart, MaxTime}, [ChildSpec]}}`

* RestartStrategy
  * <code><small>one_for_one, one_for_all, rest_for_one, simple_one_for_one</small></code>
* MaxTime ë‚´ì— MaxRestart ë˜ë©´, supervisor ìŠ¤ìŠ¤ë¡œ ì¢…ë£Œ
* ChildSpec
  * <code><small>[&#123;id, MFA, restart, shutdown, type, modules&#125;, ...]</small></code>

---

# ì½ì€ ì†Œê°?

* erlang ì˜ `supervisor` ëŠ” ì‹¤í–‰ ì´í›„ child process ë¥¼ ì¶”ê°€ / ì‚­ì œ ê°€ëŠ¥
  * elixir ì—ì„œëŠ” `Supervisor` ì™€ `DynamicSupervisor` ë¥¼ êµ¬ë¶„í•¨
* í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ì°°í•˜ê³ ì í•œë‹¤ë©´, `supervisor` ë¡œ...

```erlang
1> band_supervisor:start_link(lenient).
{ok,0.709.0>}
2> supervisor:which_children(band_supervisor).
[{keytar,<0.713.0>,worker,[musicians]},
 {drum,<0.715.0>,worker,[musicians]},
 {bass,<0.711.0>,worker,[musicians]},
 {singer,<0.710.0>,worker,[musicians]}]
```

---

## ch 18. Building an Application With OTP

---

# `ppool`

* íƒœìŠ¤í¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” process pool ê³¼ queue ë¥¼ ê°€ì§„ OTP ì•±
* `gen_server`, `supervisor` ë¥¼ í™œìš©í•´ì„œ ë­”ê°€ ì“¸ëª¨ìˆëŠ” ê²ƒì„ ë§Œë“¤ê¸° ì‹œì‘í•¨
* OTP ì•±ì— ë°˜ë“œì‹œ ì¡´ì¬í•˜ëŠ” supervision tree ë¥¼ ëª¨ë¸ë§ í•˜ëŠ” ë°©ì‹ì„ ì ê¹ ì†Œê°œ (Onion Layer Theory??)

---

## Onion Layer Theory??

ì•±ì— í•„ìš”í•œ state ë¥¼ íƒ€ì…ë³„ë¡œ ë‚˜ëˆ ë³´ë©´, supervision tree ë¥¼ êµ¬ì„±í•˜ëŠ”ë° ë„ì›€ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.

---

* `static state` â¡ï¸ supervisor
* `dynamic state (can recompute)` â¡ï¸ other process, db, env
* `dynamic state (cannot recompute)` â¡ï¸ other process (gen_server??)

---

## `ppool`'s supervision tree

<img src={require("file-loader!./images/ppool.jpg")}/>

---

## ch 19. Building OTP Applications

---

<CodeSurfer
  title="directory structure"
  lang="plain"
  code={`
â”œâ”€â”€ Emakefile
â”œâ”€â”€ ebin
â”‚Â Â  â””â”€â”€ ppool.app
â”œâ”€â”€ priv
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ *.erl
â””â”€â”€ test
    â””â”€â”€ *_tests.erl
`}
  steps={[
    {},
    {lines: [2, 4]}
  ]}/>

---

## Emakefile

```erlang
{"src/*", [debug_info, {i,"include/"}, {outdir, "ebin/"}]}.
{"test/*", [debug_info, {i,"include/"}, {outdir, "ebin/"}]}.
```

---

## Application Resource File

```erlang
{application, ppool,
  [{vsn, "1.0.0"},
  {modules, [
    ppool,
    ppool_serv,
    ppool_sup,
    ppool_supersup,
    ppool_worker_sup
  ]},
  {registered, [ppool]},
  {mod, {ppool, []}}
]}.
```

---

<CodeSurfer
  title="Application Behaviour"
  lang="erlang"
  code={require("!raw-loader!./snippets/ppool.erl")}
  steps={[
    {},
    {lines: [6,7,9,10]}
  ]}/>

---

## Application Controller

<img src={require("file-loader!./images/application_controller.jpg")}/>

* erlang vm ê³¼ í•¨ê»˜ ì‹œì‘
* ê° OTP ì•±ì„ ê´€ë¦¬í•˜ëŠ” application master ë¥¼ ì‹œì‘
  * `ppool` ì•±ë„ application master ì—ì„œ ì‹œì‘ë¨
* ìš°ë¦¬ ì•±ì„ observer ì•±ì—ì„œ ê´€ì°°í•  ìˆ˜ ìˆìŒ ğŸ‰

---

<CodeSurfer
  title="run ppool app"
  lang="erlang"
  code={`$ erl -make
$ erl -pa ebin/
1> application:start(ppool).
ok
2> ppool:start_pool(nag, 2, {ppool_naggar, start_link, []}).
{ok,<0.92.0>}
3> observer:start().
ok
`}
  steps={[
    {},
    {lines: [1], notes: "Emakefile ë¡œ ë¹Œë“œ"},
    {lines: [2], notes: "ebin/ ì˜ ëª¨ë“ˆë“¤ì„ ë¡œë“œ"},
    {lines: [3,5,7]}
  ]}
/>

---

<img src={require("file-loader!./images/observer.png")}/>

---

# ì½ì€ ì†Œê°?

* ì´ì „ì˜ ë°ëª¨ë“¤ë„ application behaviour ë¥¼ êµ¬í˜„í•˜ê³ , observer ì—ì„œ í™•ì¸í•´ë³´ê³  ì‹¶ì–´ì¡ŒìŒ
* supervision tree ë¥¼ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ì¢‹ì€ë°, observer ì— í‘œì‹œë˜ëŠ” process ì™€ module ì½”ë“œê°€ ì˜ ì—°ê²°ë  ìˆ˜ ìˆì—ˆìœ¼ë©´ ì¢‹ê² ìŒ

---

# ë
